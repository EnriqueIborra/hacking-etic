<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.5, user-scalable=yes">

  <link rel="stylesheet" href="https://cdn.hugeicons.com/font/hgi-stroke-rounded.css" />

  <title>U6 - Persist√®ncia, escalada i pivotatge</title>
  <link rel="stylesheet" href="estilsunitats.css">
  
</head>
<body>
  <!--<button class="theme-toggle" onclick="toggleTheme()"></button> -->
  <button class="theme-toggle" onclick="toggleTheme()">
    <i class="hgi hgi-stroke hgi-sun-01" id="theme-icon"></i>
  </button>

  <!-- boto menu hamburguesa  +  javascript -->
  <button class="hamburger" onclick="toggleMenu()" aria-label="Abrir men√∫ de navegaci√≥n">
    <span id="menu-icon">‚ò∞</span>
  </button>
  
  <div class="sidebar">
    <a href="#tecniques">T√®cniques persist√®ncia</a>
    <a href="#creacio">Creaci√≥ de malware</a>
    <a href="#escalada">Escalada privilegis en Linux</a>
    <a href="#escaladaw">Escalada privilegis en Windows</a>
    <a href="#pivot">T√®cniques de pivotatge</a>
    <a href="#labs">Laboratoris</a>


  </div>

  <div style="width: 100%;">
    <header>
      <a href="index.html"><img src="imgs/HEcap.png" alt="HE" width="80%"></a>
      <!--<h2>üÖ∑üÖ∞üÖ≤üÖ∫üÖ∏üÖΩüÖ∂ √àüÜÉüÖ∏üÖ≤</h2> -->
      <h1>Unitat 6: Persist√®ncia, escalada i pivotatge</h1>
      <h1>.</h1>
    </header>
    
    <main>
  <section id="tecniques">
    <h1>Persist√®ncia, escalada i pivotatge</h1>
    <p>Totes les pr√†ctiques d'este curs es realitzaran baix:     </p>
        <ul>
            <li>‚öñÔ∏è Un marc legal i √®tic</li>
            <li>üîí Entorn a√Øllat</li>
            <li>üß™ Controlat</li>
            <li>üìú Amb perm√≠s</li>
            <li>üéì Fins educatius / professionals</li>
        </ul>
  </section>
  <section>
    <h1>T√®cniques persist√®ncia</h1>
    <p>Les t√®cniques de persist√®ncia fan refer√®ncia als m√®todes que un atacant utilitza per mantenir l‚Äôacc√©s a un sistema
        durant el temps, fins i tot despr√©s de reinicis, canvis de credencials o intents de neteja. Tot a√ß√≤, sense tindre que
      realitzar tot el proc√©s d'explotaci√≥ inicial cada vegada.</p>


    <h2>Eines C&C  (C2)</h2>
    <p>MITRE defineix les accions de comanda i control (C2), com a t√®cniques per a comunicar-se amb els sistemes 
      abans compromesos i evitar ser detectats.  </p>
    <ul>
      <li>Utilitzar protocols de comunicaci√≥ habituals</li>
      <li>Utilitzar / infectar mitjans extraibles</li>
      <li>Emprar encriptaci√≥ i ofuscaci√≥</li>
    </ul>

    <h3>Alguns frameworks C2 ..</h3>
    <ol>
      <li>Cobalt Strike</li>
      <li>Covenant</li>
      <li>Empire</li>
      <li>Havoc</li>
      <li>ibombshell</li>
      <li>Silver</li>
      <li>Villain</li>
    </ol>

    <h2>M√≤duls postexplotaci√≥. Metasploit</h2>

    <ol> <strong>Recopilaci√≥ d'informaci√≥ local</strong>
      <li>post/multi/recon/local_exploit_suggester</li>
      <li>post/multi/gather/env</li>
      <li>post/multi/gather/firefox_creds</li>
      <li>post/multi/gather/ssh_creds</li>
      <li>post/multi/gather/checkvm</li>
      <li>post/windows/gather/credentials/credential_collector</li>
      <li>post/windows/gather/enum_applications</li>
      <li>post/windows/gather/enum_shares</li>
    </ol>        

    <ol> <strong>Manteniment d'acc√©s</strong>
      <li>exploit/windows/local/persistence</li>
      <li>Escalada de privilegis</li>
      <li>pivotatge en la xarxa</li>
    </ol>

  </section>         

<section id="creacio">
<h1>Creaci√≥ de malware</h1>
<h2>msfvenom</h2>
<p>Forma part del framework de metasploit, pero funciona de manera independent</p>
<h2>ZipExec</h2>
<p>Desenvolupat com a PoC de que es possible executar binaris emmagatzemats en fitxers ZIP comprimits amb contrasenya,
    evitant aix√≠ els antivirus, que no poden comprovar el contingut del fitxer</p>
 
  </section>         

    <section id="escalada">
    <h1>Escalada privilegis en Linux</h1>
    <h2>Enumeraci√≥ local en Linux</h2>
      <h3>Enumeraci√≥ Manual</h3>
      <pre>hostname
uname -a 
ifconfig   o  ip a 
netstat -tpln
/etc/hosts   i  sites-available 
/proc 
ps -ef --forest
crontab -l    i   /etc/crontab 
id    history   env    sudo -l   
find / -type f -perm 0777 2>/dev/null
find / -type f -name ".*"
find / -type f -readable     find / -type d -readable
find / -type f -writable     find / -type d -writable
find / -perm a=x 
find / -type f -perm -u=s 
find / -type f -perm  -g=s     </pre>


      <h3>Enumeraci√≥ autom√†tica</h3>
      <p>LinPEAS  (WinPEAS )</p>
      <p>Linux Smart Enumeration</p>
      <p>Linux Exploit Suggester</p>


    <h2>Escalada amb el kernel</h2>
    <ul>Algunes vulnerabilitats hist√≤riques del kernel de Linux
      <li>Dirty COW</li>
      <li>Dirty Pipe</li>
      <li>Sudo Baron Samedit</li>
      <li>OverlayFS</li>
      <li>PwnKit</li>
      <li>CVE-2022-47939 sobre ksmbd</li>
      <li>i m√©s....</li>
    </ul>

    <h2>Escalada amb sudo</h2>
    <h3>Que √©s sudo</h3>
    <p>sudo (superuser do) √©s una eina que permet a usuaris normals executar comandes amb privilegis elevats (normalment com a root),
       de manera controlada i auditada.</p>
    <p>√âs el m√®tode recomanat per a administraci√≥ segura a Linux.</p>
    <p>El fitxer <strong>sudoers</strong> defineix: Qui pot usar sudo, Quines comandes , Com (amb o sense contrasenya), Com a quin usuari</p>
    <p>üìç Ubicaci√≥ habitual: <code> /etc/sudoers </code></p>
    <p>‚ö†Ô∏è No s‚Äôha d‚Äôeditar mai directament amb editors normals.</p>
    <p> <code>visudo</code> √©s l‚Äôeina segura per editar el fitxer sudoers.</p>
    <h3>Exemple de linea de sudoers</h3>
    <code>usuari_o_grup  hosts = (usuari_execuci√≥:grup_execuci√≥) opcions  comandes </code> <br>
    <pre>alice ALL=(ALL) ALL </pre>
    
    <p>Qu√® vol dir? <br> alice ‚Üí l‚Äôusuari <br> 
      ALL ‚Üí des de qualsevol host <br> 
      (ALL) ‚Üí pot executar com a qualsevol usuari (normalment root) . (root:root) especificant usuario i grup<br>
      ALL ‚Üí pot executar qualsevol comanda , o posar una comanda concreta</p>
    <p>usuari <code>alice</code> o grup <code>%admin</code></p>

      <h3>Com saber quins binaris estan autoritzats</h3>
     <pre>sudo -l</pre>
     <p>i a continuaci√≥ , si hi ha algun comando perm√©s, buscar la forma de explotar-lo, en GTFOBINS, per a linux</p>
     <p>Per executar un comando amb un altre usuari</p>
     <pre>sudo -u nomusu nomcomando</pre>
    
    <h2>Escalada amb SUID/SGID</h2>
    <p>El bit SUID <strong>Set-User-ID</strong> √©s un mecanisme de permisos de Linux/Unix que permet 
      que un programa s‚Äôexecute amb els privilegis del propietari del fitxer, i no amb els de l‚Äôusuari que l‚Äôexecuta. </p>
      <h4>Com identificar-lo</h4>
       <pre>-rw<span style="color: darkgreen; font-weight: bold;">s</span>r-xr-x </pre>
      <h4>Com trobar fitxers amb este bit</h4>
      <pre>find / -perm -u=s -type f 2>/dev/null
find / -perm -4000 2>/dev/null        
find / -type f -perm -4000 2>/dev/null
find / -user root -perm -4000 2>/dev/null
find / -perm -4000 -exec ls -l {} \; 2>/dev/null     </pre>
    
     <br><p>El bit SGID <strong>Set Group ID</strong>  √©s un perm√≠s especial de Linux/Unix que fa que un fitxer o directori herete el grup,
       en lloc d‚Äôutilitzar el grup de l‚Äôusuari que l‚Äôexecuta o crea fitxers. √âs molt semblant al setuid, per√≤ actua sobre el grup.</p>
     <p>El SGID pot aplicar-se a: 1. Fitxers executables  2. Directoris.  I el seu comportament canvia segons el cas.</p>
     <h4>SGID en fitxers executables</h4>
     <p>Quan un executable t√© SGID activat: El programa s‚Äôexecuta amb els privilegis del grup propietari</p>
      <h4>     SGID en directoris (√∫s molt habitual) </h4>
      <p>Quan un directori t√© SGID: Tots els fitxers creats dins hereten el grup del directori  </p>
     <h4>Com identificar-lo</h4>
     <pre>-rwxr-<span style="color: darkgreen; font-weight: bold;">s</span>r-x  </pre> 
      <h4>Com trobar fitxers amb este bit</h4>
            <pre>find / -perm -g=s -type f 2>/dev/null
find / -perm -2000 2>/dev/null
find / -type f -perm -2000 2>/dev/null
find / -user root -perm -2000 2>/dev/null
find / -perm -2000 -exec ls -l {} \; 2>/dev/null     </pre>     

    <p>üß∑ El Sticky Bit √©s un perm√≠s especial de Linux/Unix que s‚Äôutilitza principalment en directoris per evitar que els
       usuaris esborren o modifiquen fitxers que no s√≥n seus, encara que tinguin permisos d‚Äôescriptura al directori.
        √âs un mecanisme clau de seguretat multiusuari.</p>
    <p>Quan el Sticky Bit est√† activat en un directori: Nom√©s poden esborrar o renombrar un fitxer: 
    1. el propietari del fitxer  2. el propietari del directori 3. o root</p>
    <h4>Com identificar-lo</h4>
     <pre>drwxrwxrw<span style="color: darkgreen; font-weight: bold;">t</span>  </pre> 
     <p>üßÆ Valor num√®ric del Sticky Bit: 1000</p>
     <h3>Escalada</h3>
     <p>Conieixent este mecanisme es podr√† fer una escalada de privilegis local a trav√©s d'estos binaris, de forma
      similar a la explicada en sudo. La web GTFOBins tamb√© te informaci√≥ sobre com utilitzar els binaris mal configurats.      </p>

    <h2>Escalada amb tasques programades</h2>
    <p>Les tasques programades amb cron permeten executar comandes o scripts autom√†ticament a Linux/Unix segons un 
      horari definit. √âs una eina fonamental d‚Äôadministraci√≥ de sistemes, per√≤ tamb√© rellevant en seguretat i auditoria.</p>
      <h3>‚è∞ Qu√® √©s cron?</h3>
      <p>cron √©s un dimoni del sistema que: S‚Äôexecuta en segon pla, Llegeix fitxers de configuraci√≥ (crontabs),
        Llan√ßa tasques a hores, dates o intervals concrets: 
        üëâ Ideal per a backups, manteniment, monitoratge i automatitzaci√≥.</p>
      <h3>üìÑ Qu√® √©s un crontab?</h3>
      <p>Un crontab √©s un fitxer que cont√© les tasques programades. Cada usuari pot tenir el seu propi crontab, i tamb√© n‚Äôhi ha de sistema.</p>
      <h4>Crontab d'usuari</h4>
      <p>S'edita amb <code>crontab -e</code> </p>
      <h4>Crontab de sistema</h4>
      <pre>Ubicacions habituals:
/etc/crontab
/etc/cron.d/
/etc/cron.hourly/
/etc/cron.daily/
/etc/cron.weekly/
/etc/cron.monthly/        </pre>
        <p>Alguns problemes comuns que permeteixen l'explotaci√≥:</p>
        <ul>
          <li>Permisos d'escriptura en l'scrip </li>
          <li>Variable d'entorn PATH</li>
          Si el PATH cont√© la ruta al <code>home</code> primer que la ruta dels binaris, es podr√† colocar en home un script malici√≥s 
          amb el mateix nom del comando que s'execute en la tasca programada
          <li>√ös de comodins o "wildcards"</li>
        </ul>

    <h2>Escalada amb serveis</h2>
    <p>Si s'identifica un servei (com per exemple MySql) executant-se com a <code>root</code>, es podrien crear 
    comandes des de dins de MySql, llan√ßar-les, i estes seran executades amb permisos de root</p>


    <h2>Escalada amb NFS (Network File System)</h2>
    <p>NFS permet compartir directoris entre sistemes Unix/Linux a trav√©s de la xarxa, de manera que un client pot muntar 
      un directori remot com si fos local. √âs molt √∫til, per√≤ perill√≥s si est√† mal configurat.</p>
      <h3>‚ö†Ô∏è Per qu√® NFS pot provocar escalada de privilegis?</h3>
      <p>NFS confia en els UID i GID del sistema client. Aix√≤ vol dir que: Si el client diu ‚Äús√≥c root‚Äù, 
        el servidor pot creure-s‚Äôho si no s‚Äôapliquen restriccions adequades. Aqu√≠ √©s on apareix el risc.</p>

    <h3>Qu√® s‚Äôavalua en una auditoria o pentest ?</h3>
      <ol>
        <li>Quins directoris s‚Äôexporten</li>
        <li>Qui hi pot accedir</li>
        <li>Si existeixen restriccions d‚Äôusuari</li>
        <li>Si els directoris s√≥n utilitzats pel sistema</li>
        <li>Si hi ha controls addicionals</li>
      </ol>

     <h3>üõ°Ô∏è Bones pr√†ctiques de seguretat amb NFS</h3> 
      <ol>
        <li>Activar sempre <strong>root squashing</strong></li>
        <li>Exportar nom√©s el necessari</li>
        <li>Limitar per IP o xarxa</li>
        <li>Evitar exportar directoris cr√≠tics</li>
        <li>Usar permisos estrictes</li>
        <li>Monitorar l‚Äô√∫s del servei</li>
        <li>Considerar alternatives m√©s segures si cal</li>
      </ol>

    </section>         

   <section id="escaladaw">
    <h1>Escalada de privilegis en Windows</h1>
    <h2>Enumeraci√≥ local</h2>
    <p>Manualment es torna prou complicat, per√≤ hi ha moltes eines que faciliten el proc√©s.</p>
    <ol>
      <li>WinPEAS</li>
      <li>JAWS</li>
      <li>SeatBelt</li>
      <li>SharpUP</li>
      <li>Metasploit Local Exploit Suggester</li>
      <li>Windows Exploit Suggester - Next Generation</li>
    </ol>
    <p>Existeix tamb√© una p√†gina similar a GTFOBins, per√≤ per a sistems Windows, anomenada  LOLBAS.</p>


    <h2>Escalada amb el kernel</h2>
    <p>Hi ha molts exploits per al kernel de windows, molts dels quals es poden practicar en la m√†quina Metasploitable3, que es 
      la versi√≥ Windows de Metasploitable.     </p>
    <p>Una de les vulnerabilitats m√©s greus √©s la HiveNightmare o SeriusSAM (CVE-2021-36934) que permet llegir les claus 
      de windows sense privilegis    </p>

      <p>Algunes ferramentes automatitzen el proc√©s de bypass UAC</p>
      <ul>
        <li>UACMe</li>
        <li>UAC-a-mola</li>
      </ul>

    <h2>Escalada amb serveis</h2>
      <p>Es poden aprofitar serveis mal configurats que corren en permisos de SYSTEM per escalar privilegis</p>
      <p>Principals problemes</p>
      <ol>
        <li>Permisos insegurs</li>
        <li>DLL Hijacking</li>
        <li>Path de servei sense cometes</li>
        <li>Permisos d√®bils en registres</li>
        <li>Serveis executables insegurs</li>
      </ol>
      <p>Uns dels serveis de windows on s'han trobat vulnerabilitats greus √©s el <code>Print Spooler</code></p>
      <ul>
        <li>PrintNighMare</li>
        <li>SpoolFool</li>
        <li>Potato Attacks</li>
      </ul>


    <h2>Escalada amb registres</h2>
      <p>Si la politica de seguretat <code>AllwaysInstallElevated</code> esta habilitada, qualsevol paquet .MSI s'executar√† amb
      privilegis administratius</p>
      <p>Tamb√© s'ha de posar especial atenci√≥ als programes que s'executen en l'autoarranc, (autorun), que tamb√© s'executen amb 
        privilegis administratius
      </p>


    <h2>Escalada amb tasques programades</h2>
    <p>Esta via d'escalat √©s similar a la explicada en entorns Linux</p>
    <p>Servei <code>Task Scheduler</code></p>
    <p>Comando: <code>schtasks</code>, obte llista de les tasques programades</p>
    <p>En Power Shell est√† <code>Get-ScheduledTask</code></p>

   </section>

    <section id="pivot">
    <h1>T√®cniques de pivotatge</h1>
    <p>El pivotatge (pivoting) √©s una t√®cnica utilitzada quan: Ja tens acc√©s a un sistema dins d‚Äôuna xarxa, per√≤ vols arribar a altres sistemes que no s√≥n accessibles directament.</p>
    <p>Aquest primer sistema comprom√®s actua com a: pont o salt intermedi  o  pivot</p>
    <p>üìå El pivotatge no √©s l‚Äôatac inicial, √©s post-explotaci√≥.</p>

      <h2>amb tunels SSH</h2>
      <p>Es crea un canal de comunicaci√≥ encapsulat a trav√©s del sistema pivot.</p>
      <p>El tr√†nsit ‚Äúviatja dins‚Äù d‚Äôun altre protocol, Permet evitar restriccions de xarxa, Molt com√∫ en xarxes corporatives</p>
      
      <h3>Local Port Forwarding</h3>
        <p>El local port forwarding permet: Obrir un port a la teva m√†quina local que redirigeix el tr√†nsit a un servei remot, a trav√©s d‚Äôun servidor intermedi (pivot).</p>
        <p>√âs molt √∫til quan: Un servei no √©s accessible directament, per√≤ s√≠ que √©s accessible des del servidor pivot</p>

      <ul> Escenari d‚Äôexemple 
        <li>(atacant / administrador): 127.0.0.1</li>
        <li>Servidor pivot: pivot.company.local</li>
        <li>Servei intern: Base de dades a 10.0.0.50:3306</li>
        <li>El servei nom√©s √©s accessible des del pivot</li>
      </ul>
      <pre>Exemple de local port Forwarding
ssh -L 13306:10.0.0.50:3306 user@pivot.company.local </pre>

      <ul>
        <li>-L  : Indica local port forwarding</li>
        <li>13306  :  Port local que s‚Äôobrir√† a la teva m√†quina (tu et connectar√†s a aquest port)</li>
        <li>10.0.0.50:3306 :   Dest√≠ final intern ( IP interna,  Port del servei (ex. MySQL))</li>
        <li>user@pivot.company.local :  Servidor intermedi (pivot) . √âs qui t√© acc√©s a la xarxa interna</li>
      </ul>

      <h3>Remote Port Forwarding</h3>
      <p>El remote port forwarding permet: Obrir un port en el servidor remot que redirigeix el tr√†nsit cap a un servei accessible des de la teva m√†quina local (o una altra m√†quina).
        √âs l‚Äôopci√≥ inversa del local port forwarding.</p>

      <ul>Escenari d‚Äôexemple
        <li>La teva m√†quina local: t√© un servei web a 127.0.0.1:8080</li>
        <li>Servidor remot: pivot.company.local</li>
        <li>El servidor remot no pot accedir directament al teu servei local</li>
        <li>Objectiu: exposar el teu servei local a trav√©s del servidor remot</li>
      </ul>
            <pre>Exemple de remote port Forwarding
ssh -R 9000:127.0.0.1:8080 user@pivot.company.local  </pre>

      <ul>
        <li>-R :  Indica remote port forwarding</li>
        <li>9000 : Port que s‚Äôobrir√† al servidor remot</li>
        <li>127.0.0.1:8080  :  Dest√≠ local (127.0.0.1 ‚Üí la teva m√†quina )  (8080 ‚Üí el servei que ja est√† escoltant localment)</li>
        <li>user@pivot.company.local :   Servidor remot on es crea el port</li>
      </ul>
      <p>üëâ Qualsevol que accedeixi a pivot.company.local:9000 , estar√† accedint indirectament al teu servei local.</p>


      <h2>amb chisel</h2>
      <p>En la m√†quina kali es pot llan√ßar en mode servidor</p>
      <pre>chisel server -p 9000 --reverse</pre>
      <p>En la m√†quina client</p>
      <pre>chisel client 10.0.1.7:9000 R:8000:127.0.0.1:8000</pre>
    </section>         



    <section id="labs">
    <h1>Laboratoris</h1>

    </section>         
   
      

    </main>

    <footer>
      <p style="font-family: 'CCSymbols', sans-serif; font-size:larger;" >
        Llic√®ncia: &#x1F16D; &#x1F16F; &#x1F10E; &#x1F10F; - U6 - Persist√®ncia, escalada i pivotatge 
      </p>
    </footer>
  </div>

  
    <script src="scriptsunitats.js"></script>
</body>
</html>
